# rename-by-tmdb

基于TMDB数据库的智能影视文件重命名工具

## 🎯 功能特性

### 核心功能
- **电影重命名**：支持电影文件的重命名规则生成
- **剧集重命名**：支持多季剧集的重命名规则生成
- **TMDB集成**：从TMDB API获取准确的影视信息
- **智能词组管理**：自动复用已存在的词组，避免重复创建

### 高级功能
- **日期模式**：支持按播出日期匹配剧集文件
- **Part模式**：支持分段剧集（Part1、Part2等）的智能重命名
  - 自动计算偏移量：Part1继承前面Part2的偏移量，Part2继承前面Part2的偏移量并递增+1
  - 非part集数区间：继承前面最近Part2的偏移量
  - 季数匹配灵活：被替换词中季数部分可有可无
  - Part大小写兼容：支持part、Part、PART等各种写法
  - 集数补0：根据总集数自动确定位数，个位数剧集自动补0
- **季数管理**：
  - 使用原文件名季数
  - 指定特定季数（支持多季选择）
  - 生成所有季（可选是否包含特别篇）
- **集数处理**：
  - 集数偏移支持（+1、-1等）
  - 集数格式选择（补0站位或不补0）
  - 集数连续性选择（影响位数计算）
  - 智能位数计算（根据最大集数自动确定）
- **智能词组管理**：自动复用已存在的词组，避免重复创建
- **远程上传**：可选上传规则到远程服务器

## 🚀 快速开始

### 1. 下载安装

从 [Releases](https://github.com/harry/rename-by-tmdb/releases) 页面下载适合您系统的版本：

#### Windows
- `rename-by-tmdb-v1.0.5-windows-amd64.zip` - x64系统（推荐）
- `rename-by-tmdb-v1.0.5-windows-arm64.zip` - ARM64系统
- `rename-by-tmdb-v1.0.5-windows-386.zip` - 32位系统

#### macOS
- `rename-by-tmdb-v1.0.5-darwin-amd64.tar.gz` - Intel芯片
- `rename-by-tmdb-v1.0.5-darwin-arm64.tar.gz` - Apple Silicon/M系列芯片

#### Linux
- `rename-by-tmdb-v1.0.5-linux-amd64.tar.gz` - x86_64系统
- `rename-by-tmdb-v1.0.5-linux-arm64.tar.gz` - ARM64系统

### 2. 解压文件
将下载的文件解压到任意目录。

### 3. 配置环境变量
在可执行文件所在目录创建 `.env` 文件：

```bash
# Windows
copy .env.example .env

# macOS/Linux
cp .env.example .env
```

编辑 `.env` 文件，设置必需的环境变量：

```env
# TMDB API密钥（必需）
TMDB_API_KEY=your_tmdb_api_key

# 远程服务器配置（可选，仅在需要上传规则时设置）
API_BASE_URL=https://msgo.xxxxx.xxx:1234  # API服务器地址
AUTH_TOKEN=your_auth_token                 # API认证令牌
UPLOAD_MS=false                           # 是否上传规则到服务器
```

> ⚠️ **重要**：`.env` 文件必须与可执行文件在同一目录下。

### 4. 运行程序

```bash
# Windows
rename-by-tmdb-windows-amd64.exe

# macOS/Linux
./rename-by-tmdb-darwin-amd64  # 或其他对应版本
```

## 📖 使用指南

### 电影重命名

1. 选择媒体类型：`1`（电影）
2. 输入TMDB电影ID
3. 输入当前文件名中的标题部分
4. 程序自动生成重命名规则

**示例输出：**
```
命名格式：
黑客帝国.1999.{[tmdbid=603;type=movie]}

被替换词：
The\.Matrix\.1999.*
替换词：
黑客帝国.1999.{[tmdbid=603;type=movie]}
```

### 剧集重命名

1. 选择媒体类型：`2`（剧集）
2. 输入TMDB剧集ID
3. 选择是否以日期判断集数
4. 输入当前文件名中的标题部分
5. 配置季数和集数选项

#### 季数配置选项

- **使用原文件名季数**：保留文件名中的季数信息
- **指定季数**：手动选择要生成的季数（如：`1;2;3`）
- **生成所有季**：自动生成所有季的重命名规则
- **包含特别篇**：是否包含第0季（特别篇）

#### 集数配置选项

- **集数偏移**：
  - 设置集数偏移量（如：`-220`）
  - 正数：向后偏移，原文件集数需要加上偏移量
  - 负数：向前偏移，原文件集数需要减去偏移量
  - 偏移后会自动设置前后定位词，提高匹配精度
- **补0站位**：
  - 选择是否在集数前补0
  - 选择补0时，会进一步询问集数是否连续
- **集数连续性**：
  - 连续集数：使用全剧最大集数确定位数（如：最大集数500→3位数）
  - 不连续集数：使用当前季最大集数确定位数
  - 确保至少使用2位数（如：01、02、03...）

#### 日期模式

当选择"以日期判断集数"时，程序会：
- 为每集生成独立的替换规则
- 使用播出日期（YYYYMMDD格式）匹配文件名
- 只处理有播出日期的集数

## 🔧 环境变量说明

| 变量名 | 必需 | 说明 |
|--------|------|------|
| `TMDB_API_KEY` | ✅ | TMDB API密钥 |
| `API_BASE_URL` | ⚠️ | API服务器地址（启用上传时必需） |
| `AUTH_TOKEN` | ⚠️ | API认证令牌（启用上传时必需） |
| `UPLOAD_MS` | ❌ | 是否启用上传功能（true/false） |

## 📁 目录结构

```
your-directory/
├── rename-by-tmdb-xxx-xxx    # 可执行文件
├── .env                      # 配置文件（必需）
├── .env.example             # 配置文件示例
└── README.md                # 说明文档
```

## 💡 使用示例

### 示例1：电影重命名（黑客帝国）

```
请选择媒体类型：
1. 电影
2. 剧集
请输入选项（1或2）: 1
请输入电影ID: 603
请输入当前文件名中的标题部分（例如：The.Matrix）: The.Matrix.1999

命名格式：
黑客帝国.1999.{[tmdbid=603;type=movie]}
词组创建成功，ID: 115

被替换词：
The\.Matrix\.1999.*
替换词：
黑客帝国.1999.{[tmdbid=603;type=movie]}
电影替换规则上传成功
```

### 示例2：剧集重命名（航海王）

```
请选择媒体类型：
1. 电影
2. 剧集
请输入选项（1或2）: 2
请输入剧集ID: 37854
是否以日期判断集数？(y/N，直接回车默认为N): 
请输入当前文件名中的标题部分（例如：One.Piece）: One.Piece
是否使用原文件名季数？(y/n，直接回车默认为y): n
请输入要生成的季数（多季用;分隔，直接回车生成所有季，0表示特别篇）: 1;2;3
请输入集数偏移量（如：+1、-1，直接回车表示不偏移）: 
集数是否补0站位？(y/n，直接回车默认为y): y
集数是否连续？(y/n，直接回车默认为y): y

=== 航海王 各季重命名正则表达式 ===

--- 第 1 季 ---
集数范围：1-61（连续，使用4位数）

被替换词：
One\.Piece.*(?:S\d{2})?E((0001|0002|0003|...|0061))
替换词：
航海王.S01E\1.1999.{[tmdbid=37854;type=tv]}
```

### 示例3：不补0的剧集重命名

```
集数是否补0站位？(y/n，直接回车默认为y): n

=== 剧集名称 各季重命名正则表达式 ===

--- 第 1 季 ---
集数范围：1-26（不补0）

被替换词：
Show\.Title.*(?:S\d{2})?E((1|2|3|...|26))
替换词：
剧集名称.S01E\1.年份.{[tmdbid=123;type=tv]}
```

### 示例4：集数偏移的剧集重命名

```
请输入集数偏移量（如：+1、-1，直接回车表示不偏移）: -220
集数是否补0站位？(y/n，直接回车默认为y): y
集数是否连续？(y/n，直接回车默认为y): y

=== 火影忍者：疾风传 各季重命名正则表达式 ===

--- 第 1 季 ---
集数范围：221-252（连续，使用3位数）
集数偏移量：-220
原始集数示例：221 → 实际集数：001

被替换词：
Naruto.*(?:S\d{2})?E((221|222|223|...|252))
替换词：
火影忍者：疾风传.S01E\1.2007.{[tmdbid=31910;type=tv]}

前定位词：
火影忍者：疾风传.S01E
后定位词：
.2007.
```

### 示例5：Part模式（分段剧集重命名）

```
请选择媒体类型：
1. 电影
2. 剧集
请输入选项（1或2）: 2
请输入剧集ID: 93550
是否以日期判断集数？(y/N，直接回车默认为N): 
命名格式：
奇葩说.2014.{[tmdbid=93550;type=tv]}
请输入当前文件名中的标题部分（例如：One.Piece）: 奇葩说6.I.Can.I.BB.2019.S06
是否有part剧集（y/n，直接回车默认为n）: y

由于选择了part模式，需要先确定要生成的季数
请输入要生成的季数（多季用;分隔，直接回车生成所有季，0表示特别篇）: 6
请输入有part的集数和part数（格式为：集数:part数，多集之间以;间隔）例如：2:2;5:2，代表第二集和第五集都有part1和part2: 2:2;5:2;24:2

=== Part剧集信息 ===
第2集: part1, part2
第5集: part1, part2
第24集: part1, part2

注意：由于选择了part剧集，自动设置为不使用原文件名季数
集数是否补0站位？(y/n，直接回车默认为y): 
集数是否连续？(y/n，直接回车默认为y): 

=== 奇葩说 各季重命名正则表达式 ===

--- 第 6 季 ---

=== 第 6 季 - Part模式 ===

第2集 part1 (偏移量:+0, 实际集数:2):
被替换词：
奇葩说6\.I\.Can\.I\.BB\.2019\.S06.*?(?:S06)?(?:E|Ep|EP|[Ee]pisode|[Ee]p)?02.*?(?:[Pp]art|PART|Part)1.*
替换词：
奇葩说.S06E02.2014.{[tmdbid=93550;type=tv]}

第2集 part2 (偏移量:+1, 实际集数:3):
被替换词：
奇葩说6\.I\.Can\.I\.BB\.2019\.S06.*?(?:S06)?(?:E|Ep|EP|[Ee]pisode|[Ee]p)?02.*?(?:[Pp]art|PART|Part)2.*
替换词：
奇葩说.S06E02.2014.{[tmdbid=93550;type=tv]}

第5集 part1 (偏移量:+1, 实际集数:6):
被替换词：
奇葩说6\.I\.Can\.I\.BB\.2019\.S06.*?(?:S06)?(?:E|Ep|EP|[Ee]pisode|[Ee]p)?05.*?(?:[Pp]art|PART|Part)1.*
替换词：
奇葩说.S06E05.2014.{[tmdbid=93550;type=tv]}

第5集 part2 (偏移量:+2, 实际集数:7):
被替换词：
奇葩说6\.I\.Can\.I\.BB\.2019\.S06.*?(?:S06)?(?:E|Ep|EP|[Ee]pisode|[Ee]p)?05.*?(?:[Pp]art|PART|Part)2.*
替换词：
奇葩说.S06E05.2014.{[tmdbid=93550;type=tv]}

第24集 part1 (偏移量:+2, 实际集数:26):
被替换词：
奇葩说6\.I\.Can\.I\.BB\.2019\.S06.*?(?:S06)?(?:E|Ep|EP|[Ee]pisode|[Ee]p)?24.*?(?:[Pp]art|PART|Part)1.*
替换词：
奇葩说.S06E24.2014.{[tmdbid=93550;type=tv]}

第24集 part2 (偏移量:+3, 实际集数:27):
被替换词：
奇葩说6\.I\.Can\.I\.BB\.2019\.S06.*?(?:S06)?(?:E|Ep|EP|[Ee]pisode|[Ee]p)?24.*?(?:[Pp]art|PART|Part)2.*
替换词：
奇葩说.S06E24.2014.{[tmdbid=93550;type=tv]}

区间 1-1 非part集数规则 (偏移量:+0):
被替换词：
奇葩说6\.I\.Can\.I\.BB\.2019\.S06.*?(?:S06)?(?:E|Ep|EP|[Ee]pisode|[Ee]p)?((01))(?!.*(?:[Pp]art|PART|Part))
替换词：
奇葩说.S06E\1.2014.{[tmdbid=93550;type=tv]}
说明：区间内集数的实际集数 = 原集数 + 0

区间 3-4 非part集数规则 (偏移量:+1):
被替换词：
奇葩说6\.I\.Can\.I\.BB\.2019\.S06.*?(?:S06)?(?:E|Ep|EP|[Ee]pisode|[Ee]p)?((03|04))(?!.*(?:[Pp]art|PART|Part))
替换词：
奇葩说.S06E\1.2014.{[tmdbid=93550;type=tv]}
说明：区间内集数的实际集数 = 原集数 + 1

区间 6-23 非part集数规则 (偏移量:+2):
被替换词：
奇葩说6\.I\.Can\.I\.BB\.2019\.S06.*?(?:S06)?(?:E|Ep|EP|[Ee]pisode|[Ee]p)?((06|07|08|09|10|11|12|13|14|15|16|17|18|19|21|22|23))(?!.*(?:[Pp]art|PART|Part))
替换词：
奇葩说.S06E\1.2014.{[tmdbid=93550;type=tv]}
说明：区间内集数的实际集数 = 原集数 + 2

注意：
1. 正则表达式中的点号（.）已经被转义
2. 替换词中的'\1'表示保留原始集数
3. [^.]* 匹配除点号外的任意字符，用于处理标题和集数之间可能存在的额外字符
4. 替换后的文件名使用TMDB中的官方剧集名称
5. 所有集数都使用相同的位数（由最大集数决定），不足位数补0
   例如：如果最大集数是500（3位），则第1集应该写作001
6. Part模式：自动识别Part1、Part2等分段信息，生成对应的替换规则
7. 偏移量计算：Part1继承前面Part2的偏移量，Part2继承前面Part2的偏移量并递增+1
8. 非part集数区间：继承前面最近Part2的偏移量
9. 季数匹配：被替换词中季数部分可有可无，适配用户输入标题中是否包含季数的情况
10. Part大小写兼容：支持part、Part、PART等各种写法
```

### 示例6：日期模式（按播出日期匹配）

```
请选择媒体类型：
1. 电影
2. 剧集
请输入选项（1或2）: 2
请输入剧集ID: 88939
是否以日期判断集数？(y/N，直接回车默认为N): y
命名格式：
向往的生活.2017.{[tmdbid=88939;type=tv]}
使用已存在的词组，ID: 307
请输入当前文件名中的标题部分（例如：One.Piece）: 向往的生活·第1季.Back.to.Field.Live.
是否使用原文件名季数？(y/n，直接回车默认为y): n
请输入要生成的季数（多季用;分隔，直接回车生成所有季，0表示特别篇）: 1

=== 向往的生活 各季重命名正则表达式 ===

--- 第 1 季 ---

=== 第 1 季 - 日期模式 ===

第1集 (播出日期: 2017-01-15):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170115.*
替换词：
向往的生活.S01E01.2017.{[tmdbid=88939;type=tv]}

第2集 (播出日期: 2017-01-22):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170122.*
替换词：
向往的生活.S01E02.2017.{[tmdbid=88939;type=tv]}

第3集 (播出日期: 2017-01-29):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170129.*
替换词：
向往的生活.S01E03.2017.{[tmdbid=88939;type=tv]}

第4集 (播出日期: 2017-02-05):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170205.*
替换词：
向往的生活.S01E04.2017.{[tmdbid=88939;type=tv]}

第5集 (播出日期: 2017-02-12):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170212.*
替换词：
向往的生活.S01E05.2017.{[tmdbid=88939;type=tv]}

第6集 (播出日期: 2017-02-19):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170219.*
替换词：
向往的生活.S01E06.2017.{[tmdbid=88939;type=tv]}

第7集 (播出日期: 2017-02-26):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170226.*
替换词：
向往的生活.S01E07.2017.{[tmdbid=88939;type=tv]}

第8集 (播出日期: 2017-03-05):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170305.*
替换词：
向往的生活.S01E08.2017.{[tmdbid=88939;type=tv]}

第9集 (播出日期: 2017-03-12):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170312.*
替换词：
向往的生活.S01E09.2017.{[tmdbid=88939;type=tv]}

第10集 (播出日期: 2017-03-19):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170319.*
替换词：
向往的生活.S01E10.2017.{[tmdbid=88939;type=tv]}

第11集 (播出日期: 2017-03-26):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170326.*
替换词：
向往的生活.S01E11.2017.{[tmdbid=88939;type=tv]}

第12集 (播出日期: 2017-04-02):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170402.*
替换词：
向往的生活.S01E12.2017.{[tmdbid=88939;type=tv]}

第13集 (播出日期: 2017-04-09):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170409.*
替换词：
向往的生活.S01E13.2017.{[tmdbid=88939;type=tv]}

第14集 (播出日期: 2017-04-16):
被替换词：
向往的生活·第1季\.Back\.to\.Field\.Live\..*20170416.*
替换词：
向往的生活.S01E14.2017.{[tmdbid=88939;type=tv]}

注意：
1. 正则表达式中的点号（.）已经被转义
2. 替换词中的'\1'表示保留原始集数
3. [^.]* 匹配除点号外的任意字符，用于处理标题和集数之间可能存在的额外字符
4. 替换后的文件名使用TMDB中的官方剧集名称
5. 日期模式：使用播出日期匹配文件名，每集生成独立的替换规则
6. 播出日期格式：YYYYMMDD（如：20170115）
7. 只处理有播出日期的集数，未获取到播出日期的集数将被跳过
8. 原文件名不包含季数，仅匹配集数部分
```

## ⚠️ 注意事项

1. **文件名标题部分**：建议包含年份等信息，避免与其他作品混淆
2. **正则表达式**：程序会自动转义特殊字符
3. **集数偏移**：
   - 正数表示向后偏移，负数表示向前偏移
   - 偏移量会影响原文件中的集数范围计算
   - 偏移后会自动设置前后定位词
4. **补0站位**：
   - 选择补0时，会询问集数是否连续
   - 连续集数使用全剧最大集数确定位数
   - 不连续集数使用当前季最大集数确定位数
5. **日期模式**：只处理有播出日期的集数
6. **Part模式**：
   - 自动识别Part1、Part2等分段信息
   - Part1不递增偏移量，Part2递增+1偏移量
   - 非part集数区间继承前面最近Part2的偏移量
   - 季数匹配灵活，支持有无季数的文件名
   - Part大小写兼容，支持各种写法
7. **季数管理**：支持指定特定季数或生成所有季

## 🔍 环境要求

- Go 1.22.5 或更高版本
- TMDB API Key
- 网络连接（访问TMDB API）
- 如需上传功能，需要有效的服务器配置

## 🤝 贡献

欢迎提交Issue和Pull Request！

## 📄 许可证

本项目采用MIT许可证。 